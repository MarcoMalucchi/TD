import numpy as np
from scipy.optimize import least_squares

# --- Inserisci qui i tuoi 53 punti ---
samples = np.array([
    [11.2255554, 5.96777773, 257.727234],
    [4.25166655, -128.496674, 223.462784],
    [-0.254999995, -227.719452, 127.562775],
    [-6.14777756, -261.195007, 1.30166662],
    [-10.499444, -226.958328, -125.208885],
    [-10.3416662, -153.233887, -201.639999],
    [-6.64333344, -1.00999999, -251.503326],
    [93.6483307, -124.360558, 207.028885],
    [135.293884, -198.282227, 102.360558],
    [143.588333, -219.46167, 3.05500007],
    [122.472221, -193.331665, -123.21167],
    [69.547226, -121.167778, -211.768326],
    [110.984444, -40.3622208, 231.157227],
    [211.991669, -94.5144424, 122.334442],
    [238.338882, -112.373337, -5.52388906],
    [198.76445, -98.7755585, -131.535553],
    [119.55278, -62.1988907, -215.508331],
    [139.596115, 32.2166672, 217.830002],
    [229.163895, 45.9488907, 124.412224],
    [259.51944, 48.5294456, -2.17722225],
    [209.520004, 36.8738899, -147.443893],
    [118.487221, 18.9150009, -223.677216],
    [94.4505539, 103.845558, 221.652771],
    [154.65834, 167.815552, 137.12056],
    [182.384995, 195.299438, -12.5794449],
    [133.514999, 145.704437, -168.218338],
    [83.1549988, 93.8388901, -221.743896],
    [-70.7616653, -104.410004, 224.899994],
    [-123.99778, -171.287216, 152.018326],
    [-155.968887, -209.281113, 2.4311111],
    [-132.907776, -175.938889, -133.232224],
    [-79.1811142, -99.2238922, -218.349442],
    [-127.923889, -28.5499992, 222.902222],
    [-220.097229, -51.7144432, 129.515549],
    [-255.118332, -60.3266678, 2.59944439],
    [-212.151672, -49.5094452, -137.059448],
    [-123.545555, -26.7544441, -219.734451],
    [-132.657776, 58.5716667, 216.108887],
    [-210.039444, 85.2483368, 132.058334],
    [-246.525558, 96.6227798, 5.05166674],
    [-204.941116, 78.3733368, -136.715561],
    [-118.137779, 44.5827789, -220.451111],
    [-81.7694473, 137.626114, 207.67334],
    [-126.416664, 200.743332, 122.91333],
    [-144.422226, 225.23056, -0.555000007],
    [-126.511665, 190.539444, -130.134445],
    [-82.6144409, 122.567223, -208.589447],
    [12.8716669, 143.184448, 219.701111],
    [17.5577774, 231.39389, 133.891663],
    [17.6855564, 268.776123, -2.80444455],
    [12.1505556, 223.978882, -137.929443],
    [4.74333334, 141.865555, -212.71611],
    [-3.46166658, 0.237777784, -250.835007]
])

# --- Normalizzazione ---
mean_samples = samples.mean(axis=0)
scale = np.max(np.std(samples, axis=0))
Xn = (samples - mean_samples)/scale

# --- Helper per pack/unpack params ---
def pack_params(b, L):
    # L lower triangular: 6 unique values (l11,l21,l22,l31,l32,l33)
    return np.hstack([b, L[0,0], L[1,0], L[1,1], L[2,0], L[2,1], L[2,2]])

def unpack_params(params):
    b = params[:3]
    l11, l21, l22, l31, l32, l33 = params[3:]
    L = np.array([[l11, 0, 0],
                  [l21, l22, 0],
                  [l31, l32, l33]])
    return b, L

# --- Funzione residuo ---
def residuals_Lb(params, X):
    b,L = unpack_params(params)
    r = np.linalg.norm((L @ (X - b).T).T, axis=1) - 1.0
    return r

# --- Stima iniziale da SVD ---
Xc = Xn - Xn.mean(axis=0)
_,_,Vt = np.linalg.svd(Xc)
b0 = Xn.mean(axis=0)
L0 = np.eye(3)
params0 = pack_params(b0,L0)

# --- Fit non lineare ---
res = least_squares(residuals_Lb, params0, args=(Xn,), method='trf', loss='soft_l1', max_nfev=5000)
b_opt, L_opt = unpack_params(res.x)

# --- Rimappare scala originale ---
b_cal = mean_samples + scale * b_opt
C_cal = L_opt / scale

# --- Test normali ---
calibrated = (C_cal @ (samples - b_cal).T).T
norms = np.linalg.norm(calibrated, axis=1)

print("Bias stimato b:", b_cal)
print("Matrice calibrazione C:\n", C_cal)
print("Norme dei vettori calibrati (devono essere ~1):", norms)
